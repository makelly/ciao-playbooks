---
# Ciao app for send discharge summary via spine
# Assumes ciao-base.yml is run first

- name: Deploy Spine TKW
  hosts: tkwspine
  sudo: True
  tasks:
    - name: Install TKW Spine
      docker:
        name: ciao-tkw-spine
        image: hscic/tkw_spine
        state: restarted
        restart_policy: always
        ports:
        - "4002:4001"

- name: Deploy ciao-docs-finalizer
  hosts: ciaodocsfinalizer
  sudo: True
  vars:
    cip_name: "ciao-docs-finalizer"
    cip_version: "1.0.0-SNAPSHOT"
    etcd_path: "{{ etcd_root }}{{ cip_name }}/{{ cip_version }}/"
    hazelcast_port: "5702"
  vars_files:
    - ciao-config.yml
  tasks:     
# Fudge until NFS setup
    - name: Create error directory
      file: path=/opt/ciao/error state=directory
# Fudge until NFS setup
    - name: Create in-progress directory
      file: path=/opt/ciao/in-progress state=directory

    - name: Set configuration item camel.log.mdc
      shell: curl {{ etcd_path }}camel.log.mdc -XPUT -d value="true"
      run_once: true
    - name: Set configuration item camel.log.trace
      shell: curl {{ etcd_path }}camel.log.trace -XPUT -d value="false"
      run_once: true
    - name: Set configuration item camel.log.debugStreams
      shell: curl {{ etcd_path }}camel.log.debugStreams -XPUT -d value="false"
      run_once: true     
    - name: Set configuration item processorConfig
      shell: curl {{ etcd_path }}processorConfig -XPUT -d value="default"
      run_once: true
    - name: Set configuration item repositoryConfig
      shell: curl {{ etcd_path }}repositoryConfig -XPUT -d value="hazelcast"
      run_once: true
    - name: Set configuration item hazelcast.group.name
      shell: curl {{ etcd_path }}hazelcast.group.name -XPUT -d value="ciao-docs-finalizer"
      run_once: true  
    - name: Set configuration item hazelcast.group.password
      shell: curl {{ etcd_path }}hazelcast.group.password -XPUT -d value="liszt"
      run_once: true  
    - name: Set configuration item hazelcast.network.port
      shell: curl {{ etcd_path }}hazelcast.network.port -XPUT -d value="{{ hazelcast_port }}"
      run_once: true  
    - name: Set configuration item hazelcast.network.join.tcp_ip.members
      shell: curl {{ etcd_path }}hazelcast.network.join.tcp_ip.members -XPUT -d value="{% for host in groups.ciaodocsfinalizer %}{{ hostvars[host].ansible_default_ipv4.address }}:{{ hazelcast_port }}{% if not loop.last %},{% endif %}{% endfor %}"
      run_once: true  
    - name: Set configuration item hazelcast.network.join.multicast.enabled
      shell: curl {{ etcd_path }}hazelcast.network.join.multicast.enabled -XPUT -d value="false"
      run_once: true  
    - name: Set configuration item inProgressFolderPollPeriod
      shell: curl {{ etcd_path }}inProgressFolderPollPeriod -XPUT -d value="500"
      run_once: true  
    - name: Set configuration item inProgressFolder
      shell: curl {{ etcd_path }}inProgressFolder -XPUT -d value="/opt/ciao-docs-finalizer/in-progress"
      run_once: true  
    - name: Set configuration item documentPreparationTimeout
      shell: curl {{ etcd_path }}documentPreparationTimeout -XPUT -d value="60000"
      run_once: true  
    - name: Set configuration item documentSendTimeout
      shell: curl {{ etcd_path }}documentSendTimeout -XPUT -d value="18000"
      run_once: true  
    - name: Set configuration item infResponseTimeout
      shell: curl {{ etcd_path }}infResponseTimeout -XPUT -d value="300000"
      run_once: true
    - name: Set configuration item busResponseTimeout
      shell: curl {{ etcd_path }}busResponseTimeout -XPUT -d value="17280000"
      run_once: true
    - name: Set configuration item idempotentActions
      shell: curl {{ etcd_path }}idempotentActions -XPUT -d value="true"
      run_once: true
    - name: Set configuration item actions
      shell: curl {{ etcd_path }}actions -XPUT -d value="to=SUCCEEDED > MoveToCompletedFolder\nto=FAILED > MoveToErrorFolder"
      run_once: true
    - name: Install ciao-docs-finalizer
      docker:
        name: ciao-docs-finalizer
        image: hscic/ciao-docs-finalizer
        state: restarted
        restart_policy: always
        ports:
        - "5702:5702"
#        - "8778:8778"
        env:
          CIAO_ETCD_URL: http://localhost:4001
        volumes:
        - "/opt/ciao/completed:/opt/ciao-docs-parser/completed"
        - "/opt/ciao/error:/opt/ciao-docs-parser/error"
        - "/opt/ciao/in-progress:/opt/ciao-docs-finalizer/in-progress"

#- name: Deploy ciao-transport-dts
#  hosts: ciaotransportdts
#  sudo: True
#  vars:
#    ciao_docs_parser_root: "test/"
#  vars_files:
#    - ciao-config.yml
#  tasks:     
#    - name: Set configuration item X
#      shell: curl {{ path }}{{ key }} -XPUT -d value="Hello Mike"
#    - name: Install ciao-transport-dts
#      docker:
#        name: ciao-transport-dts
#        image: hscic/ciao-transport-dts
#        state: restarted
#        restart_policy: always
#        ports:
#        - "8778:8778"

- name: Deploy ciao-transport-spine
  hosts: ciaotransportspine
  sudo: True
#  vars:
#    ciao_docs_parser_root: "test/"
#  vars_files:
#    - ciao-config.yml
  tasks:     
#    - name: Set configuration item X
#      shell: curl {{ path }}{{ key }} -XPUT -d value="Hello Mike"
    - name: Install ciao-transport-spine
      docker:
        name: ciao-transport-spine
        image: hscic/ciao-transport-spine
        state: restarted
        restart_policy: always
#        ports:
#        - "8122:8122"
#        - "8778:8778"
#        volumes:
#        - "{{ logstash_config_directory }}:/opt/keystores"

- name: Deploy ciao-cda-builder
  hosts: ciaocdabuilder
  sudo: True
  vars:
    cip_name: "ciao-cda-builder"
    cip_version: "1.0.0-SNAPSHOT"
    etcd_path: "{{ etcd_root }}{{ cip_name }}/{{ cip_version }}/"
  vars_files:
    - ciao-config.yml
  tasks:     
# Fudge until NFS setup
    - name: Create in-progress directory
      file: path=/opt/ciao/in-progress state=directory
    - name: Set configuration item camel.log.mdc
      shell: curl {{ etcd_path }}camel.log.mdc -XPUT -d value="true"
      run_once: true
    - name: Set configuration item camel.log.trace
      shell: curl {{ etcd_path }}camel.log.trace -XPUT -d value="false"
      run_once: true
    - name: Set configuration item camel.log.debugStreams
      shell: curl {{ etcd_path }}camel.log.debugStreams -XPUT -d value="false"
      run_once: true     
    - name: Set configuration item processorConfig
      shell: curl {{ etcd_path }}processorConfig -XPUT -d value="default"
      run_once: true
    - name: Set configuration item messagingConfig
      shell: curl {{ etcd_path }}messagingConfig -XPUT -d value="activemq"
      run_once: true
    - name: Set configuration item activemq.brokerURL
      shell: curl {{ etcd_path }}activemq.brokerURL -XPUT -d value="{{ activemq_transport }}"
      run_once: true
    - name: Set configuration item activemq.userName
      shell: curl {{ etcd_path }}activemq.userName -XPUT -d value="{{ activemq_username }}"
      run_once: true  
    - name: Set configuration item activemq.password
      shell: curl {{ etcd_path }}activemq.password -XPUT -d value="{{ activemq_password }}"
      run_once: true  
    - name: Set configuration item cdaBuilderRoutes
      shell: curl {{ etcd_path }}cdaBuilderRoutes -XPUT -d value="default"
      run_once: true  
    - name: Set configuration item cdaBuilderRoutes.outputQueue
      shell: curl {{ etcd_path }}cdaBuilderRoutes.outputQueue -XPUT -d value="{{ builder_out_q }}"
      run_once: true  
    - name: Set configuration item cdaBuilderRoutes.processorId
      shell: curl {{ etcd_path }}cdaBuilderRoutes.processorId -XPUT -d value="processor"
      run_once: true  
    - name: Set configuration item cdaBuilderRoutes.default.inputQueue
      shell: curl {{ etcd_path }}cdaBuilderRoutes.default.inputQueue -XPUT -d value="{{ enricher_out_q }}"
      run_once: true 
    - name: Set configuration item inputProgressFolder
      shell: curl {{ etcd_path }}inputProgressFolder -XPUT -d value="/opt/ciao-cda-builder/in-progress"
      run_once: true
    - name: Install ciao-cda-builder
      docker:
        name: ciao-cda-builder
        image: hscic/ciao-cda-builder
        state: restarted
        restart_policy: always
#        ports:
#        - "8778:8778"
        env:
          CIAO_ETCD_URL: http://localhost:4001
        volumes:
        - "/opt/ciao/in-progress:/opt/ciao-cda-builder/in-progress"

- name: Deploy ciao-docs-enricher
  hosts: ciaodocsenricher
  sudo: True
  vars:
    cip_name: "ciao-docs-enricher"
    cip_version: "1.0.0-SNAPSHOT"
    etcd_path: "{{ etcd_root }}{{ cip_name }}/{{ cip_version }}/"
    json_directory: "/opt/ciao/json"
  vars_files:
    - ciao-config.yml
  tasks:     
# Fudge until NFS setup
    - name: Create in-progress directory
      file: path=/opt/ciao/in-progress state=directory
# Fudge until NFS setup
    - name: Create json directory
      file: path={{ json_directory }} state=directory
    - name: Install enrich.json
      copy: src=files/enrich.json dest={{ json_directory }}/enrich.json
    - name: Set configuration item camel.log.mdc
      shell: curl {{ etcd_path }}camel.log.mdc -XPUT -d value="true"
      run_once: true
    - name: Set configuration item camel.log.trace
      shell: curl {{ etcd_path }}camel.log.trace -XPUT -d value="false"
      run_once: true
    - name: Set configuration item camel.log.debugStreams
      shell: curl {{ etcd_path }}camel.log.debugStreams -XPUT -d value="false"
      run_once: true     
    - name: Set configuration item processorConfig
      shell: curl {{ etcd_path }}processorConfig -XPUT -d value="default"
      run_once: true
    - name: Set configuration item messagingConfig
      shell: curl {{ etcd_path }}messagingConfig -XPUT -d value="activemq"
      run_once: true
    - name: Set configuration item activemq.brokerURL
      shell: curl {{ etcd_path }}activemq.brokerURL -XPUT -d value="{{ activemq_transport }}"
      run_once: true
    - name: Set configuration item activemq.userName
      shell: curl {{ etcd_path }}activemq.userName -XPUT -d value="{{ activemq_username }}"
      run_once: true  
    - name: Set configuration item activemq.password
      shell: curl {{ etcd_path }}activemq.password -XPUT -d value="{{ activemq_password }}"
      run_once: true  
    - name: Set configuration item documentEnricherRoutes
      shell: curl {{ etcd_path }}documentEnricherRoutes -XPUT -d value="default"
      run_once: true  
    - name: Set configuration item documentEnricherRoutes.outputQueue
      shell: curl {{ etcd_path }}documentEnricherRoutes.outputQueue -XPUT -d value="{{ enricher_out_q }}"
      run_once: true  
    - name: Set configuration item documentEnricherRoutes.default.enricherId
      shell: curl {{ etcd_path }}documentEnricherRoutes.default.enricherId -XPUT -d value="staticJson"
      run_once: true  
    - name: Set configuration item documentEnricherRoutes.default.inputQueue
      shell: curl {{ etcd_path }}documentEnricherRoutes.default.inputQueue -XPUT -d value="{{ parser_out_q }}"
      run_once: true  
    - name: Set configuration item staticJson.resourcePaths
      shell: curl {{ etcd_path }}staticJson.resourcePaths -XPUT -d value="/opt/ciao-docs-enricher/json/enrich.json"
      run_once: true  
    - name: Set configuration item inputProgressFolder
      shell: curl {{ etcd_path }}inputProgressFolder -XPUT -d value="/opt/ciao-docs-enricher/in-progress"
      run_once: true
    - name: Install ciao-docs-enricher
      docker:
        name: ciao-docs-enricher
        image: hscic/ciao-docs-enricher
        state: restarted
        restart_policy: always
#        ports:
#        - "8778:8778"
        env:
          CIAO_ETCD_URL: http://localhost:4001
        volumes:
        - "/opt/ciao/json:/opt/ciao-docs-enricher/json"
        - "/opt/ciao/in-progress:/opt/ciao-docs-enricher/in-progress"

- name: Deploy ciao-docs-parser
  hosts: ciaodocsparser
  sudo: True
  vars:
    cip_name: "ciao-docs-parser"
    cip_version: "1.0.0-SNAPSHOT"
    etcd_path: "{{ etcd_root }}{{ cip_name }}/{{ cip_version }}/"
    hazelcast_port: "5701"
    route_dn: "discharge-notification"
    route_ed: "ed-discharge"
    route_auto: "auto-detect"
  vars_files:
    - ciao-config.yml
  tasks:
# Fudge until NFS setup
    - name: Create input directory
      file: path=/opt/ciao/input state=directory
# Fudge until NFS setup
    - name: Create error directory
      file: path=/opt/ciao/error state=directory
# Fudge until NFS setup
    - name: Create in-progress directory
      file: path=/opt/ciao/in-progress state=directory

    - name: Set configuration item camel.log.mdc
      shell: curl {{ etcd_path }}camel.log.mdc -XPUT -d value="true"
      run_once: true
    - name: Set configuration item camel.log.trace
      shell: curl {{ etcd_path }}camel.log.trace -XPUT -d value="false"
      run_once: true
    - name: Set configuration item camel.log.debugStreams
      shell: curl {{ etcd_path }}camel.log.debugStreams -XPUT -d value="false"
      run_once: true     
    - name: Set configuration item processorConfig
      shell: curl {{ etcd_path }}processorConfig -XPUT -d value="default"
      run_once: true
    - name: Set configuration item repositoryConfig
      shell: curl {{ etcd_path }}repositoryConfig -XPUT -d value="hazelcast"
      run_once: true
    - name: Set configuration item messagingConfig
      shell: curl {{ etcd_path }}messagingConfig -XPUT -d value="activemq"
      run_once: true
    - name: Set configuration item activemq.brokerURL
      shell: curl {{ etcd_path }}activemq.brokerURL -XPUT -d value="{{ activemq_transport }}"
      run_once: true
    - name: Set configuration item activemq.userName
      shell: curl {{ etcd_path }}activemq.userName -XPUT -d value="{{ activemq_username }}"
      run_once: true  
    - name: Set configuration item activemq.password
      shell: curl {{ etcd_path }}activemq.password -XPUT -d value="{{ activemq_password }}"
      run_once: true  
    - name: Set configuration item hazelcast.group.name
      shell: curl {{ etcd_path }}hazelcast.group.name -XPUT -d value="ciao-docs-parser"
      run_once: true  
    - name: Set configuration item hazelcast.group.password
      shell: curl {{ etcd_path }}hazelcast.group.password -XPUT -d value="mozart"
      run_once: true  
    - name: Set configuration item hazelcast.network.port
      shell: curl {{ etcd_path }}hazelcast.network.port -XPUT -d value="{{ hazelcast_port }}"
      run_once: true  
    - name: Set configuration item hazelcast.network.join.tcp_ip.members
      shell: curl {{ etcd_path }}hazelcast.network.join.tcp_ip.members -XPUT -d value="{% for host in groups.ciaodocsparser %}{{ hostvars[host].ansible_default_ipv4.address }}:{{ hazelcast_port }}{% if not loop.last %},{% endif %}{% endfor %}"
      run_once: true  
    - name: Set configuration item hazelcast.network.join.multicast.enabled
      shell: curl {{ etcd_path }}hazelcast.network.join.multicast.enabled -XPUT -d value="false"
      run_once: true  
    - name: Set configuration item documentParserRoutes
      shell: curl {{ etcd_path }}documentParserRoutes -XPUT -d value="{{ route_dn }},{{ route_ed }},{{ route_auto}}"
      run_once: true  
    - name: Set configuration item documentParserRoutes.outputQueue
      shell: curl {{ etcd_path }}documentParserRoutes.outputQueue -XPUT -d value="{{ parser_out_q }}"
      run_once: true  
    - name: Set configuration item documentParserRoutes.inProgressFolder
      shell: curl {{ etcd_path }}documentParserRoutes.inProgressFolder -XPUT -d value="/opt/ciao-docs-parser/in-progress"
      run_once: true  
    - name: Set configuration item documentParserRoutes.idempotentRespositoryId
      shell: curl {{ etcd_path }}documentParserRoutes.idempotentRespositoryId -XPUT -d value="idempotentRespository"
      run_once: true  
    - name: Set configuration item documentParserRoutes.inProgressRepositoryId
      shell: curl {{ etcd_path }}documentParserRoutes.inProgressRepositoryId -XPUT -d value="inProgressRepository"
      run_once: true  
    - name: Set configuration item documentParserRoutes.{{ route_dn }}.inputFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_dn }}.inputFolder -XPUT -d value="/opt/ciao-docs-parser/input/{{ route_dn }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_dn }}.completedFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_dn }}.completedFolder -XPUT -d value="{{ completed_folder_root }}/{{ route_dn }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_dn }}.errorFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_dn }}.errorFolder -XPUT -d value="/opt/ciao-docs-parser/error/{{ route_dn }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_dn }}.processorId
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_dn }}.processorId -XPUT -d value="dischargeNotificationProcessor"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_ed }}.inputFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_ed }}.inputFolder -XPUT -d value="/opt/ciao-docs-parser/input/{{ route_ed }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_ed }}.completedFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_ed }}.completedFolder -XPUT -d value="{{ completed_folder_root }}/{{ route_ed }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_ed }}.errorFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_ed }}.errorFolder -XPUT -d value="/opt/ciao-docs-parser/error/{{ route_ed }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_ed }}.processorId
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_ed }}.processorId -XPUT -d value="edDischargeProcessor"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_auto }}.inputFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_auto }}.inputFolder -XPUT -d value="/opt/ciao-docs-parser/input/{{ route_auto }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_auto }}.completedFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_auto }}.completedFolder -XPUT -d value="{{ completed_folder_root }}/{{ route_auto }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_auto }}.errorFolder
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_auto }}.errorFolder -XPUT -d value="/opt/ciao-docs-parser/error/{{ route_auto }}"
      run_once: true
    - name: Set configuration item documentParserRoutes.{{ route_auto }}.processorId
      shell: curl {{ etcd_path }}documentParserRoutes.{{ route_auto }}.processorId -XPUT -d value="autoDetectProcessor"
      run_once: true
    - name: Install ciao-docs-parser
      docker:
        name: ciao-docs-parser
        image: hscic/ciao-docs-parser
        state: restarted
        restart_policy: always
        ports:
        - "5701:5701"
#        - "8778:8778"
        env:
          CIAO_ETCD_URL: http://localhost:4001
        volumes:
        - "/opt/ciao/input:/opt/ciao-docs-parser/input"
        - "/opt/ciao/error:/opt/ciao-docs-parser/error"
        - "/opt/ciao/in-progress:/opt/ciao-docs-parser/in-progress"
